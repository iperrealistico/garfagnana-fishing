// Sistema multilingua completo con TUTTE le traduzioni
const translations = {
    it: {
        'prenota-nav': 'Prenota online',
        'dove-nav': 'Dove pescare',
        'chi-nav': 'Chi siamo',
        'video-nav': 'I nostri video',
        'servizi-nav': 'Vitto, alloggio e guide',
        'come-nav': 'Come raggiungerci',
        'hero-title': 'Garfagnana Fishing',
        'hero-subtitle': 'Il posto in cui non sei mai stato e dove non vedrai l\'ora di tornare',
        'cta-dove': 'Dove pescare',
        'cta-chi': 'Chi siamo',
        'cta-vitto': 'Vitto e alloggio',
        'cta-video': 'I nostri video',
        'app-title': 'Scarica l\'app per prenotare',
        'app-desc': 'Prenota online scaricando l\'app Hooking, ci trovi direttamente lì e puoi pagare con carta di credito!',
        'dove-title': 'Dove pescare in Garfagnana?',
        'dove-desc': 'Per gli appassionati di pesca il territorio della Garfagnana offre una miriade di corsi e specchi d\'acqua che attraversa l\'intera valle, dalle Alpi Apuane fino alle pendici dell\'Appennino Tosco-Emiliano. Ambienti magici e incontaminati dove trascorrere del tempo a contatto con la natura più autentica praticando la propria passione. Per rendere questa esperienza più accessibile e indimenticabile ci sono a disposizione 2 zone a regolamento specifico. Trovate tutti i dettagli nelle schede che seguono.',
        'download-maps': 'Scarica le mappe',
        'download-rules': 'Scarica il regolamento',
        'incubatoio-label': 'Incubatoio',
        'incubatoio-title': 'Incubatoio',
        'open-maps': 'Apri su Google Maps',
        'chi-title': 'Cosa è Garfagnana Fishing?',
        'chi-desc1': 'Garfagnanafishing nasce dagli sforzi congiunti di Garfagnanadream.it, portale per la promozione multimediale del territorio e del Mosca Club Lucca, associazione di pescatori e appassionati da anni attiva a livello provinciale per la gestione e la conservazione dei tratti fluviali di maggior pregio.',
        'chi-desc2': 'L\'idea nasce per colmare l\'assenza sul territorio di una struttura in grado di occuparsi a livello professionale del settore turistico legato alla pesca. A oggi, infatti, è impossibile rimanere indifferenti di fronte ai risultati raggiunti da altri territori del nostro Paese, dove la pesca turistica contribuisce a interi indotti con numeri a 6 cifre.',
        'chi-desc3': 'Gli obbiettivi sono portare sul territorio una nuova consapevolezza nei confronti di questa risorsa e sensibilizzare sulla delicatezza e l\'importanza degli ecosistemi teatro dell\'attività di pesca.',
        'video-title': 'I nostri video, documentari e vlog!',
        'servizi-title': 'Scopri le nostre guide e i consigli per vitto e alloggio',
        'servizi-desc': 'In questa sezione troverete alcuni spunti per un soggiorno di qualità in Garfagnana e godervi i prodotti tipici della cucina locale. Per un\'esperienza ancora più immersiva potete rivolgervi alle nostre guide di pesca, che potranno esaudire ogni vostro desiderio, portandovi oltre le nostre zone a regolamento specifico. La Garfagnana vi aspetta per una vacanza avventurosa e indimenticabile.',
        'tab-guide': 'GUIDE DI PESCA',
        'tab-mangiare': 'DOVE MANGIARE',
        'tab-dormire': 'DOVE DORMIRE',
        'tab-altre': 'ALTRE INFO',
        'guide-fly': 'Mosca',
        'website': 'Sito Web',
        'facebook-page': 'pagina Facebook',
        'altre-title': 'Scopri tantissime altre idee e servizi su Garfagnanadream.it',
        'altre-desc': 'Visita il portale turistico a 360° sulla Garfagnana: servizi turistici, idee viaggio, natura, sport e attività! Scopri con noi la verde valle della Garfagnana.',
        'come-title': 'Come raggiungerci per pescare in Garfagnana',
        'come-desc': 'Auto, treno e anche aereo. Scoprite tutte le indicazioni per raggiungere la Garfagnana nella nostra guida.',
        'acc-auto': 'In auto',
        'acc-aereo': 'In aereo',
        'acc-treno': 'In treno',
        'acc-auto-content': 'L\'auto è l\'opzione migliore per godersi alcune delle città più famose al mondo prima di immergersi nei territori incontaminati della Garfagnana. Da Firenze (1:30 h) è necessario proseguire in direzione Lucca, scegliendo l\'uscita Lucca Est per un giro in centro e da qui si prosegue sulla SR445 per la Garfagnana. Stessa cosa per quanto riguarda Pisa (1 h), a meno che non si opti per la SS12 radd passante per San Giuliano Terme. Da Lucca (45 min), invece, è sufficiente seguire le indicazioni per la Garfagnana, mentre dalla Versilia (1 h) ci si possono godere due passi di montagna molto suggestivi: quello del Cipollaio e quello del Vestito, da imboccare rispettivamente in corrispondenza di Querceta e Massa. Si arriva anche direttamente da Modena (2 h), grazie alla SP72.',
        'acc-aereo-content': 'Grazie ai collegamenti degli aeroporti internazionali di Pisa e Firenze è possibile arrivare direttamente in queste città da tutta Europa (Lisbona, Valencia, Barcellona, Madrid, Francoforte, Monaco, Parigi, Londra, Amsterdam, Ginevra e non solo). Da qui si può proseguire in auto o in treno.',
        'acc-treno-content': 'Entrambi gli aeroporti sono collegati direttamente con le relative stazioni principali (Pisa Centrale – Firenze Santa Maria Novella). Le soluzioni a disposizione sono unicamente treni regionali che impiegano parecchio tempo per percorrere la tratta. Ci vogliono circa 1 ora e 30 da Pisa, 2 ore 45 da Firenze, 50 min da Lucca, 50 minuti dalla stazione di Aulla-Lunigiana e in media 1 ora e 30 dalla Versilia (Viareggio).',
        'zrs-alto-desc': 'Classificazione a salmonidi, carattere torrentizio ideale per trota mediterranea autoctona. Avviamento di un incubatoio, tecnica del cocooning, obiettivo tutela e rusticità delle trote autoctone.',
        'zrs-isola-desc': 'Bacino artificiale alimentato dal torrente Turrite Secca, nel cuore delle Apuane. Borgo medievale che lambisce il bacino, ristoranti e punti di ristoro accessibili.',
        'incubatoio-desc': 'Gestione per riproduzione artificiale della Trota Fario Mediterranea. Sede in località Casonza nel comune di Fosciandora.'
    },
    en: {
        'prenota-nav': 'Book online',
        'dove-nav': 'Where to fish',
        'chi-nav': 'About us',
        'video-nav': 'Our videos',
        'servizi-nav': 'Food, accommodation & guides',
        'come-nav': 'How to reach us',
        'hero-title': 'Garfagnana Fishing',
        'hero-subtitle': 'The place you\'ve never been and where you can\'t wait to return',
        'cta-dove': 'Where to fish',
        'cta-chi': 'About us',
        'cta-vitto': 'Food & lodging',
        'cta-video': 'Our videos',
        'app-title': 'Download the app to book',
        'app-desc': 'Book online by downloading the Hooking app, find us directly there and pay by credit card!',
        'dove-title': 'Where to fish in Garfagnana?',
        'dove-desc': 'For fishing enthusiasts, the Garfagnana territory offers countless waterways crossing the entire valley, from the Apuan Alps to the Tuscan-Emilian Apennines. Magical and uncontaminated environments where you can spend time in contact with the most authentic nature while practicing your passion. To make this experience more accessible and unforgettable, there are 2 specific regulation zones available. Find all the details in the following cards.',
        'download-maps': 'Download maps',
        'download-rules': 'Download regulations',
        'incubatoio-label': 'Hatchery',
        'incubatoio-title': 'Hatchery',
        'open-maps': 'Open on Google Maps',
        'chi-title': 'What is Garfagnana Fishing?',
        'chi-desc1': 'Garfagnanafishing was born from the joint efforts of Garfagnanadream.it, a portal for multimedia promotion of the territory, and Mosca Club Lucca, an association of fishermen and enthusiasts active for years at provincial level in the management and conservation of the most valuable river sections.',
        'chi-desc2': 'The idea arose to fill the absence in the territory of a structure capable of dealing professionally with the tourism sector linked to fishing. Today, in fact, it is impossible to remain indifferent to the results achieved by other territories in our country, where fishing tourism contributes to entire industries with 6-figure numbers.',
        'chi-desc3': 'The objectives are to bring new awareness to the territory regarding this resource and raise awareness about the delicacy and importance of ecosystems that are the setting for fishing activities.',
        'video-title': 'Our videos, documentaries and vlogs!',
        'servizi-title': 'Discover our guides and tips for food and accommodation',
        'servizi-desc': 'In this section you will find some ideas for a quality stay in Garfagnana and enjoy the typical products of local cuisine. For an even more immersive experience, you can contact our fishing guides, who can fulfill your every wish, taking you beyond our specific regulation zones. Garfagnana awaits you for an adventurous and unforgettable vacation.',
        'tab-guide': 'FISHING GUIDES',
        'tab-mangiare': 'WHERE TO EAT',
        'tab-dormire': 'WHERE TO SLEEP',
        'tab-altre': 'OTHER INFO',
        'guide-fly': 'Fly',
        'website': 'Website',
        'facebook-page': 'Facebook page',
        'altre-title': 'Discover many other ideas and services on Garfagnanadream.it',
        'altre-desc': 'Visit the 360° tourist portal on Garfagnana: tourist services, travel ideas, nature, sports and activities! Discover the green valley of Garfagnana with us.',
        'come-title': 'How to reach us for fishing in Garfagnana',
        'come-desc': 'Car, train and even plane. Discover all directions to reach Garfagnana in our guide.',
        'acc-auto': 'By car',
        'acc-aereo': 'By plane',
        'acc-treno': 'By train',
        'acc-auto-content': 'The car is the best option to enjoy some of the most famous cities in the world before diving into the uncontaminated territories of Garfagnana. From Florence (1:30 h) you need to continue towards Lucca, choosing the Lucca Est exit for a tour of the center and from here continue on SR445 to Garfagnana. Same thing for Pisa (1 h), unless you opt for the SS12 passing through San Giuliano Terme. From Lucca (45 min), however, just follow the signs for Garfagnana, while from Versilia (1 h) you can enjoy two very suggestive mountain passes: Cipollaio and Vestito, to be taken respectively at Querceta and Massa. You can also arrive directly from Modena (2 h), thanks to SP72.',
        'acc-aereo-content': 'Thanks to the connections of the international airports of Pisa and Florence, it is possible to arrive directly in these cities from all over Europe (Lisbon, Valencia, Barcelona, Madrid, Frankfurt, Munich, Paris, London, Amsterdam, Geneva and more). From here you can continue by car or train.',
        'acc-treno-content': 'Both airports are directly connected to their respective main stations (Pisa Centrale – Firenze Santa Maria Novella). The only solutions available are regional trains that take a long time to travel the route. It takes about 1 hour and 30 from Pisa, 2 hours 45 from Florence, 50 min from Lucca, 50 minutes from Aulla-Lunigiana station and on average 1 hour and 30 from Versilia (Viareggio).',
        'cookie-title': 'This site uses cookies',
        'cookie-desc': 'We use cookies to improve your experience. By continuing you accept our cookie policy.',
        'cookie-accept': 'Accept',
        'cookie-settings': 'Settings',
        'zrs-alto-desc': 'Salmonid classification, torrential character ideal for native Mediterranean trout. Hatchery startup, cocooning technique, objective of protection and rusticity of native trout.',
        'zrs-isola-desc': 'Artificial basin fed by the Turrite Secca stream, in the heart of the Apuan Alps. Medieval village that touches the basin, restaurants and refreshment points accessible.',
        'incubatoio-desc': 'Management for artificial reproduction of Mediterranean Brown Trout. Headquarters in Casonza in the municipality of Fosciandora.'
    }
};

let currentLang = 'it';
let currentPanel = null;
let currentVideoIndex = 0;
let videoUrls = [];

// Gestione menu mobile
function toggleMobileMenu() {
    const burger = document.querySelector('.burger-menu');
    const menu = document.querySelector('.mobile-menu');
    burger.classList.toggle('active');
    menu.classList.toggle('active');
}

function closeMobileMenu() {
    const burger = document.querySelector('.burger-menu');
    const menu = document.querySelector('.mobile-menu');
    burger.classList.remove('active');
    menu.classList.remove('active');
}

// Cambio lingua
function toggleLanguage() {
    currentLang = currentLang === 'it' ? 'en' : 'it';
    document.documentElement.lang = currentLang;

    document.querySelectorAll('[data-lang]').forEach(el => {
        const key = el.getAttribute('data-lang');
        if (translations[currentLang][key]) {
            el.textContent = translations[currentLang][key];
        }
    });

    document.getElementById('lang-label').textContent = currentLang === 'it' ? 'Italiano' : 'English';

    const flagIcon = document.getElementById('flag-icon');
    if (currentLang === 'en') {
        flagIcon.innerHTML = `
                <rect width="24" height="16" fill="#012169"></rect>
                <path d="M0,0 L24,16 M24,0 L0,16" stroke="white" stroke-width="3"></path>
                <path d="M0,0 L24,16 M24,0 L0,16" stroke="#C8102E" stroke-width="2"></path>
                <path d="M12,0 V16 M0,8 H24" stroke="white" stroke-width="5"></path>
                <path d="M12,0 V16 M0,8 H24" stroke="#C8102E" stroke-width="3"></path>
            `;
    } else {
        flagIcon.innerHTML = `
                <rect width="8" height="16" fill="#009246"></rect>
                <rect x="8" width="8" height="16" fill="#FFFFFF"></rect>
                <rect x="16" width="8" height="16" fill="#CE2B37"></rect>
            `;
    }

    localStorage.setItem('preferredLang', currentLang);
}

// Sistema di gestione immagini con placeholder automatici
function initImageSystem() {
    document.querySelectorAll('.img-container').forEach(container => {
        const imgPath = container.getAttribute('data-img');
        const placeholderType = container.getAttribute('data-placeholder') || 'default';

        if (imgPath) {
            const img = new Image();
            img.onload = function () {
                if (container.classList.contains('hero-bg')) {
                    container.style.backgroundImage = `url('${imgPath}')`;
                } else if (container.classList.contains('main-logo')) {
                    container.innerHTML = `<img src="${imgPath}" alt="Logo" style="width: 100%; height: 100%;">`;
                } else if (container.classList.contains('store-badge')) {
                    container.innerHTML = `<img src="${imgPath}" alt="Badge" style="height: 60px;">`;
                } else if (container.classList.contains('drop-cap-logo')) {
                    container.innerHTML = `<img src="${imgPath}" alt="Logo">`;
                } else {
                    container.innerHTML = `<img src="${imgPath}" alt="" style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius);">`;
                }
            };

            img.onerror = function () {
                createPlaceholder(container, placeholderType);
            };

            img.src = imgPath;
        } else {
            createPlaceholder(container, placeholderType);
        }
    });
}

function createPlaceholder(container, type) {
    let placeholder = '';

    if (container.classList.contains('hero-bg')) {
        container.innerHTML = '<div class="img-placeholder full-cover"></div>';
        return;
    }

    if (container.classList.contains('drop-cap-logo')) {
        container.innerHTML = '<div style="width: 100%; height: 100%; background: #E5E7EB; border-radius: 50%;"></div>';
        return;
    }

    switch (type) {
        case 'logo':
            placeholder = '<div style="width: 120px; height: 120px; background: #E5E7EB; border-radius: 50%;"></div>';
            break;
        case 'badge':
            placeholder = '<div style="width: 180px; height: 60px; background: #E5E7EB; border-radius: 8px;" class="skeleton"></div>';
            break;
        case 'card':
            placeholder = '<div class="img-placeholder" style="height: 100%;"></div>';
            break;
        case 'large':
            placeholder = '<div class="img-placeholder" style="height: 100%;"></div>';
            break;
        case 'small':
            placeholder = '<div class="img-placeholder" style="width: 100%; height: 100%;"></div>';
            break;
        default:
            placeholder = '<div class="img-placeholder"></div>';
    }

    container.innerHTML = placeholder;
}

// Estrae ID YouTube da vari tipi di URL
function extractYouTubeId(url) {
    try {
        const urlObj = new URL(url);
        if (urlObj.hostname === 'youtu.be') {
            return urlObj.pathname.slice(1);
        }
        if (urlObj.searchParams.get('v')) {
            return urlObj.searchParams.get('v');
        }
        const parts = urlObj.pathname.split('/').filter(Boolean);
        const embedIndex = parts.indexOf('embed');
        if (embedIndex !== -1 && parts[embedIndex + 1]) {
            return parts[embedIndex + 1];
        }
        return null;
    } catch (e) {
        return null;
    }
}

function getEmbedUrlFromWatch(url) {
    const id = extractYouTubeId(url);
    if (!id) return null;
    return 'https://www.youtube.com/embed/' + id;
}

// Inizializza le thumbnail dei video usando i.ytimg.com
function initVideoThumbnails() {
    const videoCards = document.querySelectorAll('#video-grid .card');
    videoCards.forEach((card, index) => {
        const dataDiv = card.querySelector('[data-video-url]');
        if (!dataDiv) return;
        const url = dataDiv.getAttribute('data-video-url');
        if (!url || url.includes('PLACEHOLDER')) return;

        const id = extractYouTubeId(url);
        if (!id) return;

        const thumbnailUrl = 'https://i.ytimg.com/vi/' + id + '/hqdefault.jpg';
        const container = dataDiv.parentElement;
        const existingImg = container.querySelector('img');
        if (existingImg) {
            existingImg.remove();
        }
        const img = document.createElement('img');
        img.src = thumbnailUrl;
        img.alt = 'Anteprima video ' + (index + 1);
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        container.insertBefore(img, container.firstChild);

        videoUrls[index] = url;
    });
}

// Gestione video con lightbox
function openLightbox(index) {
    const videoCards = document.querySelectorAll('#video-grid .card');
    const card = videoCards[index];
    if (!card) return;

    const dataDiv = card.querySelector('[data-video-url]');
    if (!dataDiv) return;

    const videoUrl = dataDiv.getAttribute('data-video-url');
    if (!videoUrl || videoUrl.includes('PLACEHOLDER')) {
        alert('Video non ancora disponibile. Sostituire PLACEHOLDER_VIDEO_ID con l\'ID reale del video YouTube.');
        return;
    }

    const embedUrl = getEmbedUrlFromWatch(videoUrl);
    if (!embedUrl) {
        alert('URL del video non valido.');
        return;
    }

    currentVideoIndex = index;
    const lightbox = document.getElementById('video-lightbox');
    const frame = document.getElementById('video-frame');
    frame.src = embedUrl + '?autoplay=1';
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeLightbox() {
    const lightbox = document.getElementById('video-lightbox');
    const frame = document.getElementById('video-frame');
    lightbox.classList.remove('active');
    frame.src = '';
    document.body.style.overflow = '';
}

function navigateVideo(direction) {
    const videoCards = document.querySelectorAll('#video-grid .card');
    if (!videoCards.length) return;

    currentVideoIndex = (currentVideoIndex + direction + videoCards.length) % videoCards.length;
    const card = videoCards[currentVideoIndex];
    const dataDiv = card.querySelector('[data-video-url]');
    if (!dataDiv) return;

    const videoUrl = dataDiv.getAttribute('data-video-url');
    if (!videoUrl || videoUrl.includes('PLACEHOLDER')) {
        // salta i placeholder
        navigateVideo(direction);
        return;
    }

    const embedUrl = getEmbedUrlFromWatch(videoUrl);
    if (!embedUrl) return;

    const frame = document.getElementById('video-frame');
    frame.src = embedUrl + '?autoplay=1';
}

// Pannelli ZRS
function togglePanel(panelId) {
    const panel = document.getElementById('panel-' + panelId);
    if (!panel) return;

    if (currentPanel && currentPanel !== panel) {
        currentPanel.classList.remove('active');
    }

    panel.classList.toggle('active');
    currentPanel = panel.classList.contains('active') ? panel : null;

    if (panel.classList.contains('active')) {
        const rect = panel.getBoundingClientRect();
        const offset = window.pageYOffset + rect.top - 120;
        window.scrollTo({ top: offset, behavior: 'smooth' });
    }
}

function closePanel() {
    if (currentPanel) {
        currentPanel.classList.remove('active');
        currentPanel = null;
    }
}

// Tabs servizi
function switchTab(event, tabId) {
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => tab.classList.remove('active'));
    contents.forEach(content => content.classList.remove('active'));

    event.currentTarget.classList.add('active');
    const activeContent = document.getElementById(tabId);
    if (activeContent) {
        activeContent.classList.add('active');
    }
}

// Accordion
function toggleAccordion(accordion) {
    const isActive = accordion.classList.contains('active');
    document.querySelectorAll('.accordion').forEach(acc => acc.classList.remove('active'));
    if (!isActive) {
        accordion.classList.add('active');
    }
}

// Animazioni on scroll
function initScrollAnimations() {
    const elements = document.querySelectorAll('.animate-on-scroll');
    if (!('IntersectionObserver' in window)) {
        elements.forEach(el => el.classList.add('visible'));
        return;
    }

    const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                obs.unobserve(entry.target);
            }
        });
    }, { threshold: 0.15 });

    elements.forEach(el => observer.observe(el));
}

// Evidenziazione nav in base alla sezione
function initNavHighlight() {
    const sections = Array.from(document.querySelectorAll('section[id]'));
    const navLinks = Array.from(document.querySelectorAll('.navbar .nav-pill, .mobile-menu .nav-pill'));

    function onScroll() {
        const scrollPos = window.scrollY + 140;
        let currentId = null;

        for (const section of sections) {
            if (scrollPos >= section.offsetTop && scrollPos < section.offsetTop + section.offsetHeight) {
                currentId = section.id;
                break;
            }
        }

        navLinks.forEach(link => {
            const href = link.getAttribute('href');
            if (!href || !href.startsWith('#')) return;
            const id = href.substring(1);
            if (id === currentId) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
    }

    window.addEventListener('scroll', onScroll);
    onScroll();
}

document.addEventListener('DOMContentLoaded', function () {
    const storedLang = localStorage.getItem('preferredLang');
    if (storedLang === 'en') {
        toggleLanguage();
    }

    initImageSystem();
    initVideoThumbnails();
    initScrollAnimations();
    initNavHighlight();
});

// Chiudi lightbox con ESC
document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
        closeLightbox();
    }
});
